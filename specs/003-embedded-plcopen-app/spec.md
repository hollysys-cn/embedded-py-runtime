# Feature Specification: 嵌入式 PLCOpen 控制应用程序

**Feature Branch**: `003-embedded-plcopen-app`
**Created**: 2026-01-18
**Status**: Draft
**Input**: User description: "创建一个嵌入式程序，包含上个迭代开发的PLCOpen功能块"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - PID 闭环温度控制演示 (Priority: P1) 🎯 MVP

作为嵌入式系统开发者，我需要一个完整的 PID 闭环控制演示程序，模拟温度控制系统，展示 PID 功能块与 PT1 滤波器的实际应用。

**Why this priority**: PID 控制是工业自动化最核心的应用场景。温度控制是最常见、最直观的例子，可以完整展示 PID 参数调节、滤波器降噪、设定值跟踪等关键功能。作为 MVP，用户可以立即理解如何将功能块库应用于实际控制问题。

**Independent Test**: 运行程序后，观察模拟温度从初始值逐步逼近设定值，验证超调量、稳态误差和响应时间是否在预期范围内。通过控制台输出或日志文件查看控制过程数据。

**Acceptance Scenarios**:

1. **Given** 程序启动并配置目标温度为 80°C（初始温度 25°C），**When** 运行控制循环 200 个周期，**Then** 模拟温度应在 100 个周期内达到稳态（误差 < 1°C），超调量 < 10%
2. **Given** 传感器信号包含高斯噪声（振幅 ±1°C），**When** 使用 PT1 滤波器处理，**Then** 滤波后的信号波动应减少 50% 以上
3. **Given** PID 控制器处于自动模式，**When** 切换到手动模式并调整输出，**Then** 输出应锁定在用户设定值，返回自动模式时无扰动切换
4. **Given** 程序运行中，**When** 动态修改目标温度从 80°C 到 60°C，**Then** 控制器应平滑跟踪新设定值
5. **Given** 程序配置了输出限幅（0-100%），**When** PID 计算结果超出范围，**Then** 输出应被限制并触发 Anti-Windup 机制

---

### User Story 2 - 斜坡信号发生与限幅联合演示 (Priority: P2)

作为电机控制开发者，我需要一个展示斜坡发生器（RAMP）和限幅器（LIMIT）协同工作的演示程序，模拟电机软启动过程。

**Why this priority**: 斜坡函数用于避免机械冲击，限幅器保护设备安全。两者配合是运动控制和过程控制的标准模式。

**Independent Test**: 设置目标速度和加速斜率，验证输出按设定速率平滑变化，且始终在安全限幅范围内。

**Acceptance Scenarios**:

1. **Given** RAMP 配置上升速率为 10 单位/秒，目标从 0 变为 100，**When** 运行 15 秒，**Then** 输出应在约 10 秒时达到 100，且全程线性上升
2. **Given** LIMIT 配置范围为 [0, 80]，**When** RAMP 输出试图达到 100，**Then** 最终输出应被限制在 80，并设置 HI_LIM 状态标志
3. **Given** RAMP 正在执行上升斜坡，**When** 目标突然改为 50，**Then** RAMP 应从当前位置开始下降斜坡至 50

---

### User Story 3 - 信号处理链演示 (Priority: P2)

作为传感器数据处理开发者，我需要一个展示信号处理链（滤波→死区→限幅）的演示程序，模拟工业传感器信号预处理。

**Why this priority**: 信号预处理是所有控制系统的前置步骤。演示多个功能块串联使用的模式，是用户构建复杂系统的基础。

**Independent Test**: 输入带噪声的模拟传感器信号，验证经过处理链后输出稳定、无高频噪声、无微小抖动。

**Acceptance Scenarios**:

1. **Given** 输入信号包含高频噪声，**When** 通过 PT1 滤波器，**Then** 高频成分被有效衰减
2. **Given** 滤波后信号在死区范围内波动（±1 单位），**When** 通过 DEADBAND 处理，**Then** 输出保持恒定
3. **Given** 信号处理链输出超出安全范围，**When** 通过 LIMIT 限幅，**Then** 输出被限制在配置范围内

---

### User Story 4 - 积分计量与累计量演示 (Priority: P3)

作为计量系统开发者，我需要一个展示积分器功能的演示程序，模拟流量累计或能量统计。

**Why this priority**: 积分器用于生产统计、计费等场景，是工业测量的基础功能。

**Independent Test**: 输入恒定流量信号，验证积分器输出随时间线性增加，复位功能正常。

**Acceptance Scenarios**:

1. **Given** 积分器配置采样周期 0.1s，**When** 持续输入流量 10 L/s，运行 100 秒，**Then** 累计量应为 1000L（±1% 误差）
2. **Given** 积分器配置输出限幅 5000L，**When** 积分值接近限幅，**Then** 应触发限幅状态标志并停止积分
3. **Given** 积分器正在运行，**When** 用户触发复位，**Then** 积分值归零，状态清除

---

### User Story 5 - 微分变化率检测演示 (Priority: P3)

作为振动监测开发者，我需要一个展示微分器功能的演示程序，模拟从位置信号计算速度。

**Why this priority**: 微分器用于速度/加速度计算，是振动分析和运动控制的基础。

**Independent Test**: 输入斜坡位置信号，验证微分器输出恒定速度值。

**Acceptance Scenarios**:

1. **Given** 微分器配置采样周期 0.01s，**When** 输入斜率 100/s 的斜坡信号，**Then** 输出应稳定在 100（±5% 误差）
2. **Given** 微分器配置了滤波时间常数 0.05s，**When** 输入阶跃信号，**Then** 输出应为平滑脉冲而非无穷大尖峰

---

### Edge Cases

- **仿真时间同步**: 程序应支持可配置的仿真采样周期，可加速运行或实时运行
- **参数越界保护**: 用户输入非法参数（如负的时间常数）时，程序应报错并使用安全默认值
- **长时间运行**: 积分器长时间运行不应发生浮点溢出，应在接近极限值时自动限幅
- **噪声鲁棒性**: 即使输入信号包含较大噪声，控制系统仍应保持稳定
- **首次运行**: 所有功能块首次调用时应正确初始化，避免冷启动跳变

## Requirements *(mandatory)*

### Functional Requirements

**核心演示程序**:

- **FR-001**: 系统 MUST 提供 PID 闭环控制演示程序，模拟一阶惯性被控对象（如温度系统）
- **FR-002**: PID 演示程序 MUST 包含模拟被控对象模型，响应控制器输出并产生过程反馈
- **FR-003**: PID 演示程序 MUST 支持动态修改设定值，观察控制器跟踪响应
- **FR-004**: PID 演示程序 MUST 展示手动/自动模式切换的无扰动特性
- **FR-005**: 系统 MUST 提供斜坡发生器与限幅器联合演示程序

**信号处理演示**:

- **FR-006**: 系统 MUST 提供信号处理链演示程序（PT1 → DEADBAND → LIMIT）
- **FR-007**: 信号处理链演示 MUST 使用模拟传感器信号（含可配置噪声）

**计量演示**:

- **FR-008**: 系统 MUST 提供积分器累计量演示程序
- **FR-009**: 系统 MUST 提供微分器变化率演示程序

**通用要求**:

- **FR-010**: 所有演示程序 MUST 使用 002 迭代开发的 PLCOpen 功能块库
- **FR-011**: 所有演示程序 MUST 可在 x86 主机上模拟运行（用于开发测试）
- **FR-012**: 所有演示程序 MUST 可交叉编译到 ARM Cortex-M4 目标平台
- **FR-013**: 所有演示程序 MUST 提供运行数据输出（控制台打印或日志）
- **FR-014**: 演示程序 MUST 使用固定时间步长仿真，采样周期可配置
- **FR-015**: 所有演示程序 MUST 包含清晰的中文注释说明控制逻辑

**可移植性要求**:

- **FR-016**: 程序 MUST 使用 C11 标准，与 001 迭代环境兼容
- **FR-017**: 程序 MUST 仅使用静态内存分配，不使用 malloc/free
- **FR-018**: 程序 MUST 可在无操作系统（裸机）环境运行
- **FR-019**: 标准库依赖限于 `stdio.h`（用于输出）、`math.h`（用于数学函数）、`stdint.h`（用于定宽整数）

**构建系统**:

- **FR-020**: 系统 MUST 提供 CMake 构建配置，支持独立编译每个演示程序
- **FR-021**: CMake 配置 MUST 支持 x86 本机编译和 ARM 交叉编译两种模式

### Key Entities

- **PlantModel（被控对象模型）**: 模拟物理系统响应，包含增益、时间常数、当前状态。用于闭环仿真。
- **NoiseGenerator（噪声发生器）**: 生成可配置幅度的随机噪声，模拟传感器测量误差。
- **SimulationConfig（仿真配置）**: 包含采样周期、运行时长、输出频率等仿真参数。
- **ControllerConfig（控制器配置）**: 封装 PID 参数、限幅设置、模式选择等控制参数。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: PID 闭环演示在标准一阶惯性对象上稳态误差 < 1%，超调量 < 10%
- **SC-002**: 所有演示程序可成功编译运行，无编译警告（在 -Wall -Wextra 下）
- **SC-003**: 演示程序在 x86 和 ARM Cortex-M4 两个平台均可正确运行
- **SC-004**: 每个演示程序代码量 < 500 行（不含注释和空行），保持简洁易读
- **SC-005**: 所有演示程序在 100,000 次循环测试中无崩溃或数值异常
- **SC-006**: 演示程序输出的数据可用于生成控制曲线图（CSV 格式或可解析的控制台输出）
- **SC-007**: 用户阅读注释后可在 30 分钟内理解并修改演示程序

## Assumptions

以下假设用于填补需求中的细节：

1. **仿真模式**: 演示程序采用离散时间仿真，不依赖实时时钟，通过固定步长循环推进
2. **被控对象模型**: PID 演示使用标准一阶惯性模型 G(s) = K/(τs+1)，其中 K=1.0, τ=5.0s，模拟典型热系统
3. **噪声模型**: 传感器噪声使用简单的伪随机数生成，振幅可配置
4. **输出格式**: 演示程序通过 `printf` 输出时间戳、设定值、过程值、控制输出等数据，每行一个采样周期
5. **目标硬件**: ARM 平台演示程序可通过 UART 输出数据（假设平台提供基本的串口支持）
6. **无RTOS**: 演示程序在裸机环境运行，使用简单的 while 循环作为主循环
7. **功能块复用**: 直接使用 002 迭代开发的功能块库，不做任何修改
8. **随机数生成**: 使用简单的线性同余生成器（LCG），不依赖标准库 rand()
