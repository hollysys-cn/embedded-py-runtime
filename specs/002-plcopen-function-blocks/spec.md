# Feature Specification: PLCopen 基础功能块库

**Feature Branch**: `002-plcopen-function-blocks`
**Created**: 2026-01-18
**Status**: Draft
**Input**: User description: "构建程序,包含PLCopen基础功能块，如：PID、一阶惯性、等常用基础功能块"

## Clarifications

### Session 2026-01-18

- Q: PID 控制器的微分项滤波方式如何处理？ → A: 微分项先行滤波（Derivative on Measurement）
- Q: 积分抗饱和（Anti-Windup）的具体实现策略是什么？ → A: 条件积分法
- Q: 数值保护中的溢出处理策略应该如何实现？ → A: 限幅到有效范围并设置错误标志
- Q: 功能块的 API 接口设计风格应遵循什么模式？ → A: 结构体 + 分离的 Init/Execute 函数
- Q: 单元测试和验证的测试框架应该使用什么？ → A: Unity（嵌入式 C 单元测试框架）
- Q: 除零保护的处理策略是什么？ → A: 使用最小有效值替代零
- Q: NaN/Inf 输入的处理策略是什么？ → A: 检测后输出零并设置错误标志
- Q: 功能块首次调用时的初始化行为应该如何设计？ → A: 使用首次输入作为初始输出
- Q: 采样周期异常（零或负数）的处理策略是什么？ → A: 在初始化时验证并拒绝无效配置

## User Scenarios & Testing *(mandatory)*

### User Story 1 - PID 控制器功能块 (Priority: P1) 🎯 MVP

作为嵌入式控制系统开发者，我需要一个符合 PLCopen 标准的 PID 控制器功能块，以便在工业控制应用中实现闭环控制。

**Why this priority**: PID 控制器是工业自动化中最基础、最常用的控制算法。几乎所有过程控制系统都依赖 PID 实现温度、压力、流量、位置等参数的精确控制。作为 MVP，PID 功能块能立即为用户提供核心控制能力。

**Independent Test**: 可通过模拟过程响应（如一阶惯性系统）测试 PID 控制效果，验证稳态误差、响应时间和超调量是否满足要求。

**Acceptance Scenarios**:

1. **Given** PID 功能块已初始化（Kp=1.0, Ki=0.1, Kd=0.05），**When** 设定值从 0 跳变到 100，**Then** 输出应在合理时间内收敛到设定值，稳态误差小于 1%
2. **Given** PID 功能块正在运行，**When** 设置积分限幅（anti-windup），**Then** 积分项不应超出设定的上下限
3. **Given** PID 功能块正在运行，**When** 手动切换到手动模式，**Then** 输出应锁定在当前值，PID 计算暂停
4. **Given** PID 处于手动模式，**When** 切换回自动模式，**Then** 应实现无扰动切换，输出不发生突变
5. **Given** PID 功能块配置完成，**When** 调用周期性执行函数，**Then** 应在微秒级完成计算（适合实时控制）

---

### User Story 2 - 一阶惯性（PT1）滤波器功能块 (Priority: P1) 🎯 MVP

作为信号处理开发者，我需要一阶惯性滤波器功能块，用于平滑传感器信号和消除高频噪声。

**Why this priority**: 一阶惯性滤波是信号处理的基础，几乎所有传感器数据都需要滤波处理。与 PID 配合使用可显著提高控制系统稳定性。

**Independent Test**: 输入阶跃信号，验证输出响应曲线符合一阶惯性特性（时间常数 τ 后达到 63.2%）。

**Acceptance Scenarios**:

1. **Given** PT1 功能块已配置时间常数 τ=1.0s，采样周期 Ts=0.01s，**When** 输入阶跃信号，**Then** 输出应在 1τ 后达到 63.2%，3τ 后达到 95%
2. **Given** PT1 功能块正在运行，**When** 输入包含高频噪声的信号，**Then** 输出应有效滤除高频成分
3. **Given** PT1 功能块初次调用，**When** 未提供初始值，**Then** 应使用输入信号作为初始输出值（避免冷启动跳变）

---

### User Story 3 - 斜坡发生器（RAMP）功能块 (Priority: P2)

作为运动控制开发者，我需要斜坡发生器功能块，用于实现平滑的设定值变化，避免机械设备受到冲击。

**Why this priority**: 斜坡函数是运动控制和过程控制中常用的设定值预处理功能，可防止阶跃变化对执行机构的冲击。

**Independent Test**: 设置目标值和斜坡速率，验证输出按设定速率线性变化直至达到目标。

**Acceptance Scenarios**:

1. **Given** RAMP 功能块配置上升速率为 10 单位/秒，**When** 目标从 0 变为 100，**Then** 输出应在 10 秒内线性增加到 100
2. **Given** RAMP 正在执行斜坡变化，**When** 目标值突然改变，**Then** 应从当前输出值开始新的斜坡
3. **Given** RAMP 功能块配置了上升和下降不同的速率，**When** 目标值变化，**Then** 应使用对应方向的速率

---

### User Story 4 - 限幅器（LIMIT）功能块 (Priority: P2)

作为安全系统开发者，我需要限幅器功能块，确保输出信号始终在安全范围内。

**Why this priority**: 限幅是保护执行机构和保证系统安全的基础功能，在所有控制回路中都需要使用。

**Independent Test**: 输入超出限幅范围的信号，验证输出被正确限制在设定范围内。

**Acceptance Scenarios**:

1. **Given** LIMIT 功能块配置范围为 [0, 100]，**When** 输入 150，**Then** 输出应为 100
2. **Given** LIMIT 功能块配置范围为 [0, 100]，**When** 输入 -50，**Then** 输出应为 0
3. **Given** LIMIT 功能块运行中，**When** 输出被限幅，**Then** 应设置限幅状态标志（HI_LIM 或 LO_LIM）

---

### User Story 5 - 死区处理（DEADBAND）功能块 (Priority: P3)

作为控制系统优化工程师，我需要死区处理功能块，消除微小信号波动导致的执行机构频繁动作。

**Why this priority**: 死区处理可减少阀门、电机等执行机构的磨损，延长设备寿命。

**Independent Test**: 输入在死区范围内变化的信号，验证输出保持不变。

**Acceptance Scenarios**:

1. **Given** DEADBAND 配置死区宽度为 ±2，**When** 输入在 48-52 范围内变化（中心值 50），**Then** 输出应保持为 50
2. **Given** DEADBAND 功能块运行中，**When** 输入超出死区范围，**Then** 输出应跟随输入变化

---

### User Story 6 - 积分器（INTEGRATOR）功能块 (Priority: P3)

作为过程控制开发者，我需要积分器功能块，用于计算累计量（如流量累计、能量累计）。

**Why this priority**: 积分器是计量和统计应用的基础，支持生产统计和计费系统。

**Independent Test**: 输入恒定信号，验证输出随时间线性增加。

**Acceptance Scenarios**:

1. **Given** 积分器配置采样周期为 0.1s，**When** 持续输入 10，**Then** 每秒输出增加 10
2. **Given** 积分器正在运行，**When** 调用复位，**Then** 积分值归零
3. **Given** 积分器配置了输出限幅，**When** 积分值达到限幅，**Then** 应停止积分并设置状态标志

---

### User Story 7 - 微分器（DERIVATIVE）功能块 (Priority: P3)

作为振动分析开发者，我需要微分器功能块，计算信号的变化率。

**Why this priority**: 微分用于速度计算（从位置）、加速度计算（从速度）等应用。

**Independent Test**: 输入斜坡信号，验证输出为恒定的斜率值。

**Acceptance Scenarios**:

1. **Given** 微分器配置采样周期为 0.01s，**When** 输入斜率为 100/s 的斜坡，**Then** 输出应接近 100
2. **Given** 微分器配置了滤波时间常数，**When** 输入阶跃信号，**Then** 输出应为平滑的脉冲而非无穷大尖峰

---

### Edge Cases

- 数值溢出：当输入值接近浮点数极限时，功能块限幅到 FLT_MIN/FLT_MAX 并设置错误标志，输出仍然可用
- 除零保护：涉及除法的计算（如时间常数、采样周期）当值为零或小于 1e-6 时，使用最小有效值 1e-6 替代，避免除零错误
- NaN/Inf 处理：检测到输入为 NaN 或 Inf 时，输出零值并设置错误标志，提供安全的中性输出
- 首次调用：功能块首次执行时，使用首次输入值作为初始输出（滤波器、积分器）或初始状态，实现无跳变启动
- 采样周期异常：初始化时验证采样周期必须大于零且小于合理上限（如 1000s），无效配置返回错误并阻止功能块启动

## Requirements *(mandatory)*

### Functional Requirements

**核心功能块**:

- **FR-001**: 系统 MUST 提供 PID 控制器功能块，支持 P、PI、PD、PID 四种模式
- **FR-002**: PID 功能块 MUST 支持积分抗饱和（Anti-Windup）机制，采用条件积分法（当输出达到限幅时停止积分累加）
- **FR-003**: PID 功能块 MUST 支持手动/自动模式无扰动切换
- **FR-004**: PID 功能块 MUST 支持输出限幅配置
- **FR-004a**: PID 功能块的微分项 MUST 采用微分项先行滤波（Derivative on Measurement），即仅对过程测量值求微分而非对误差求微分，以避免设定值突变产生的微分尖峰
- **FR-005**: 系统 MUST 提供一阶惯性滤波器（PT1）功能块
- **FR-006**: 系统 MUST 提供斜坡发生器（RAMP）功能块，支持独立的上升/下降速率
- **FR-007**: 系统 MUST 提供限幅器（LIMIT）功能块，并输出限幅状态

**辅助功能块**:

- **FR-008**: 系统 MUST 提供死区处理（DEADBAND）功能块
- **FR-009**: 系统 MUST 提供积分器（INTEGRATOR）功能块，支持复位和限幅
- **FR-010**: 系统 MUST 提供微分器（DERIVATIVE）功能块，内置滤波以避免噪声放大

**通用要求**:

- **FR-011**: 所有功能块 MUST 使用 C11 标准实现
- **FR-012**: 所有功能块 MUST 可在 ARM Cortex-M4 平台上运行
- **FR-013**: 所有功能块 MUST 提供初始化和周期执行两个独立函数（如 `FB_PID_Init()` 和 `FB_PID_Execute()`）
- **FR-013a**: 所有功能块首次执行时 MUST 使用首次输入值作为初始输出或内部状态，实现无跳变平滑启动
- **FR-014**: 所有功能块 MUST 支持多实例（每个实例独立状态）
- **FR-015**: 所有功能块 MUST 包含数值保护（溢出、除零、NaN检测）。溢出时输出限幅到 FLT_MIN/FLT_MAX 范围并设置错误标志；除法运算中的关键参数（时间常数、采样周期等）小于 1e-6 时使用 1e-6 替代；检测到 NaN/Inf 输入时输出零并设置错误标志
- **FR-016**: 所有功能块 MUST 提供状态输出（正常、限幅、错误等）

**接口规范**:

- **FR-017**: 功能块接口 MUST 遵循 PLCopen 命名约定
- **FR-018**: 功能块 MUST 使用结构体封装所有参数和状态，采用 `<FB名>_t` 命名（如 `FB_PID_t`）
- **FR-019**: 功能块 MUST 提供配置验证函数（如 `FB_PID_ValidateConfig()`），在初始化时检查参数有效性（采样周期 > 0 且 < 1000s，时间常数 > 0，限幅上限 > 下限等），无效配置返回错误码并阻止功能块启动

### Key Entities
，微分项先行滤波（仅对测量值求微分）
- **FB_PID**: PID 控制器 - 包含 Kp、Ki、Kd 参数，手动/自动模式，积分限幅，输出限幅
- **FB_PT1**: 一阶惯性滤波器 - 包含时间常数 τ，采样周期 Ts，内部状态
- **FB_RAMP**: 斜坡发生器 - 包含上升速率、下降速率、目标值、当前输出
- **FB_LIMIT**: 限幅器 - 包含上限、下限、限幅状态标志
- **FB_DEADBAND**: 死区处理 - 包含死区宽度、中心值
- **FB_INTEGRATOR**: 积分器 - 包含积分值、限幅、复位功能
- **FB_DERIVATIVE**: 微分器 - 包含滤波时间常数、前一采样值

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: PID 控制器在典型一阶系统上可实现稳态误差 < 1%
- **SC-002**: 所有功能块单次执行时间 < 10μs（在 Cortex-M4 @168MHz 上）
- **SC-003**: 功能块库总代码量 < 50KB（Flash占用）
- **SC-004**: 功能块库总RAM占用 < 2KB（静态分配）
- **SC-005**: 所有功能块通过单元测试覆盖率 > 90%
- **SC-006**: 功能块接口符合 PLCopen 规范中的命名和行为约定
- **SC-007**: 提供完整的 API 文档和使用示例

## Assumptions

以下假设用于填补需求中的细节：

1. **采样周期**: 假设用户以固定周期调用功能块，周期由用户在初始化时指定
2. **数据类型**: 所有数值计算使用 `float`（单精度浮点），适合 Cortex-M4 FPU
3. **线程安全**: 功能块本身非线程安全，用户负责在多任务环境中保护调用
4. **内存模型**: 采用静态内存分配，无动态内存分配
5. **PLCopen 标准**: 参考 PLCopen Motion Control Part 1 和 IEC 61131-3 的功能块概念
6. **错误处理**: 检测到错误时设置状态标志，输出保持最后有效值
7. **测试框架**: 单元测试使用 Unity 嵌入式 C 测试框架，支持目标硬件上的测试执行
