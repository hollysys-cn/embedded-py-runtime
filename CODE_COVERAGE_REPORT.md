# PLCopen 功能块代码覆盖率报告

## 执行摘要

**生成时间**: 2024 年 12 月 28 日

**总体覆盖率**: 49% (117/235 行)

**模块覆盖情况**:
- ✅ 已完成测试: 3/8 模块 (common, fb_pid, fb_pt1)
- ⚠️ 待开发测试: 5/8 模块 (fb_deadband, fb_derivative, fb_integrator, fb_limit, fb_ramp)

**说明**: 当前覆盖率报告仅反映已有完整测试的 3 个核心模块。其余 5 个模块的实现代码已完成,但测试文件为占位符(仅 `TEST_IGNORE` 测试),因此这些模块的代码未被测试执行。

---

## 详细覆盖率数据

### 完整测试模块

| 模块 | 行数 | 执行 | 覆盖率 | 未覆盖行 | 测试用例数 | 状态 |
|------|------|------|--------|----------|------------|------|
| common.c | 18 | 18 | **100%** | - | 14 | ✅ 完美 |
| fb_pid.c | 73 | 71 | **97%** | 41, 61 | 18 | ✅ 优秀 |
| fb_pt1.c | 29 | 28 | **96%** | 13 | 10 | ✅ 优秀 |

**小计**: 120 行，117 执行，**97% 覆盖率**

### 待测试模块(占位符测试)

| 模块 | 行数 | 执行 | 覆盖率 | 原因 | 对应任务 |
|------|------|------|--------|------|----------|
| fb_deadband.c | 16 | 0 | **0%** | 仅占位符测试 | T055 |
| fb_derivative.c | 29 | 0 | **0%** | 仅占位符测试 | T070 |
| fb_integrator.c | 26 | 0 | **0%** | 仅占位符测试 | T063 |
| fb_limit.c | 18 | 0 | **0%** | 仅占位符测试 | T048 |
| fb_ramp.c | 26 | 0 | **0%** | 仅占位符测试 | T041 |

**小计**: 115 行，0 执行，**0% 覆盖率**

---

## 未覆盖行分析

### fb_pid.c (97% 覆盖)

**未覆盖行**: 41, 61

**原因**: 这两行可能是:
- 第 41 行: 特殊错误条件分支(如 NaN/Inf 检测边界情况)
- 第 61 行: 特定状态码路径(如特殊限幅条件)

**建议**: 添加边界条件和异常输入测试用例覆盖这些代码路径

### fb_pt1.c (96% 覆盖)

**未覆盖行**: 13

**原因**: 可能是:
- 参数验证失败分支
- 特殊错误处理路径

**建议**: 添加无效参数测试用例

---

## 待开发测试任务详情

### 1. T041 - RAMP 功能块测试
**文件**: `tests/plcopen/test_fb_ramp.c`

**需要测试场景**:
- 配置验证：rate <= 0、sample_time <= 0 或 > 1000s
- 上升斜坡（速率和时间）
- 下降斜坡
- 目标值突变（从当前值开始新斜坡）
- 不对称速率（上升快下降慢）
- 首次调用行为
- 状态码输出

**估计用例数**: ~12 个测试

---

### 2. T048 - LIMIT 功能块测试
**文件**: `tests/plcopen/test_fb_limit.c`

**需要测试场景**:
- 配置验证：max <= min
- 上限限幅（状态 FB_STATUS_LIMIT_HI）
- 下限限幅（状态 FB_STATUS_LIMIT_LO）
- 正常范围（状态 FB_STATUS_OK，无限幅）
- 边界值（精确等于 min 或 max）
- 首次调用行为

**估计用例数**: ~10 个测试

---

### 3. T055 - DEADBAND 功能块测试
**文件**: `tests/plcopen/test_fb_deadband.c`

**需要测试场景**:
- 配置验证：width < 0
- 死区内信号（输出不变）
- 死区外信号（输出跟随）
- 死区边界值
- 零死区宽度（直通模式）
- 首次调用行为
- 状态码输出

**估计用例数**: ~10 个测试

---

### 4. T063 - INTEGRATOR 功能块测试
**文件**: `tests/plcopen/test_fb_integrator.c`

**需要测试场景**:
- 配置验证：sample_time <= 0 或 > 1000s, out_max <= out_min（如启用限幅）
- 恒定输入累积（线性增长）
- 复位功能
- 输出限幅（状态 FB_STATUS_LIMIT_HI/LO）
- 首次调用行为（积分值从0开始）
- 数值保护（溢出、NaN/Inf 输入）
- 状态码输出

**估计用例数**: ~12 个测试

---

### 5. T070 - DERIVATIVE 功能块测试
**文件**: `tests/plcopen/test_fb_derivative.c`

**需要测试场景**:
- 配置验证：sample_time <= 0 或 > 1000s
- 恒定输入（导数为0）
- 线性变化输入（导数为斜率）
- 突变输入（高导数值）
- 首次调用行为（无历史数据）
- 数值保护（NaN/Inf 输入）
- 输出限幅（如配置）
- 状态码输出

**估计用例数**: ~12 个测试

---

## 完成测试的工作量估算

| 任务 | 测试用例数 | 预计时间 | 优先级 |
|------|------------|----------|--------|
| T041 - RAMP | 12 | 2-3 小时 | P2 |
| T048 - LIMIT | 10 | 2 小时 | P2 |
| T055 - DEADBAND | 10 | 2 小时 | P3 |
| T063 - INTEGRATOR | 12 | 2-3 小时 | P3 |
| T070 - DERIVATIVE | 12 | 2-3 小时 | P3 |
| **总计** | **56** | **10-13 小时** | - |

---

## 建议行动计划

### 选项 A: 立即完成所有测试
- ✅ 优点: 完整覆盖率数据，高质量保证
- ⚠️ 缺点: 需要额外 10-13 小时开发时间
- 适用场景: 项目有充足时间，需要完整验证

### 选项 B: 分阶段完成(推荐)
1. **立即**: 完成 P2 优先级测试 (RAMP, LIMIT) - 约 4-5 小时
2. **后续**: 根据实际需求完成 P3 测试 (DEADBAND, INTEGRATOR, DERIVATIVE)
3. **持续**: 逐步提升现有模块覆盖率至 100%

- ✅ 优点: 平衡进度和质量，关键功能先保障
- ✅ 优点: 可以并行进行其他开发工作
- 适用场景: 项目有时间压力，需要分阶段交付

### 选项 C: 最小化测试
- 仅为每个模块添加基本的正向测试用例（各 2-3 个）
- 预计时间: 2-3 小时
- ✅ 优点: 快速提升覆盖率至 60-70%
- ⚠️ 缺点: 边界条件和异常情况未充分测试

---

## 技术说明

### 测试环境
- **测试框架**: Unity 2.5.2
- **覆盖率工具**: gcovr 5.0 + GCC gcov
- **编译器**: GCC 11.4.0
- **执行环境**: Docker (Ubuntu 22.04)

### 覆盖率收集方法
```bash
# 编译时启用覆盖率标志
gcc -std=c11 --coverage -fprofile-arcs -ftest-coverage \
    -I./include -I./.toolchain/unity/src \
    src/plcopen/common.c \
    src/plcopen/fb_xxx.c \
    tests/plcopen/test_fb_xxx.c \
    .toolchain/unity/src/unity.c \
    -lm -o build/coverage/test_fb_xxx

# 运行测试生成 .gcda 文件
./build/coverage/test_fb_xxx

# 生成覆盖率报告
gcovr build/coverage \
    --root . \
    --html-details build/coverage/coverage.html \
    --txt build/coverage/coverage.txt
```

### 已知问题
1. ⚠️ fb_pid.c 第 41, 61 行未覆盖 - 需要添加边界条件测试
2. ⚠️ fb_pt1.c 第 13 行未覆盖 - 需要添加无效参数测试
3. ⚠️ 5 个模块测试文件为占位符 - 需要实现完整测试逻辑

---

## 结论

当前 **已测试模块的覆盖率为 97%**(120/120 行中的 117 行),质量优秀。但项目整体覆盖率仅为 49% (235/235 行中的 117 行),因为 5 个功能块模块尚未编写完整测试用例。

**建议**: 采用选项 B (分阶段完成),优先完成 P2 优先级模块测试(RAMP, LIMIT),确保核心功能质量,同时不阻塞项目进度。
