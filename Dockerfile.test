# PLCopen 功能块库测试环境 Docker 镜像
# 基于 Ubuntu 22.04，包含 GCC、ARM 工具链、Unity 测试框架

FROM ubuntu:22.04

LABEL maintainer="Hollysys Embedded Team"
LABEL description="PLCopen Function Blocks Test Environment"
LABEL version="1.0.0"

# 设置非交互模式（避免 apt 询问）
ENV DEBIAN_FRONTEND=noninteractive

# 使用阿里云镜像源（加速中国大陆用户）
RUN sed -i 's@//.*archive.ubuntu.com@//mirrors.aliyun.com@g' /etc/apt/sources.list && \
    sed -i 's@//.*security.ubuntu.com@//mirrors.aliyun.com@g' /etc/apt/sources.list

# 安装基础工具和编译器
RUN apt-get update && apt-get install -y \
    # 构建工具
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    # ARM 交叉编译工具链
    gcc-arm-none-eabi \
    binutils-arm-none-eabi \
    libnewlib-arm-none-eabi \
    # 开发工具
    git \
    wget \
    curl \
    vim \
    # 静态分析工具
    cppcheck \
    # 代码覆盖率工具
    gcovr \
    lcov \
    # Python（用于脚本）
    python3 \
    python3-pip \
    # 其他实用工具
    file \
    tree \
    && rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /workspace

# 创建构建输出目录
RUN mkdir -p /workspace/build /workspace/reports

# 设置环境变量
ENV CC=gcc
ENV CXX=g++
ENV PATH="/workspace/scripts/build:${PATH}"

# 验证工具安装
RUN gcc --version && \
    arm-none-eabi-gcc --version && \
    cppcheck --version

# 设置默认命令
CMD ["/bin/bash"]

# 构建说明
# docker build -f Dockerfile.test -t plcopen-test:latest .
# docker run -it -v $(pwd):/workspace plcopen-test:latest
